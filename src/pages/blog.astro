---
import { getCollection } from 'astro:content';
import { Show } from "solid-js";
import Base from '../Base.astro';
import { getSimplifiedDate, getUTCDateComponents } from '../util/dateTools';
import GridTitle from '../components/blog/GridTitle';
import SVGIcon from '../components/SVGIcon.astro';

// TODO: search, filtering, sorting, view modes (grid, list, feed)

// TODO: dynamically adjust tag filter counts

type TagData = {
	name: string,
	count: number
}

type TagList = TagData[]

const posts = await getCollection(`blog`);

posts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

const taglist: TagList = [];

for (const post of posts) {
	for (const currentTag of post.data.tags) {
		let found = false;
		search: for (let i = 0; i < taglist.length; i++) {
			const existingTag = taglist[i];
			if (existingTag.name == currentTag) {
				found = true;
				taglist[i].count++;
				break search;
			}
		}

		if (!found) {
			taglist.push({
				name: currentTag,
				count: 1
			});
		}
	}
}

taglist.sort((a, b) => b.count - a.count);

---

<Base title="blog">
	<div class="wrapper large">
		<aside class="contentBox">
			<div class="searchBar">
				<input type="search" placeholder="search" autocomplete="off"/>
				<SVGIcon src="/icons/search.svg" class="searchIcon"/>
			</div>
			<div class="exactOnly">
				<label class="checkbox">
					<span>exact matches only</span>
					<input type="checkbox" autocomplete="off" />
					<div class="stylizedCheckbox">
						<SVGIcon src="/icons/check.svg" class="checkIcon"/>
					</div>
				</label>
			</div>
			<div class="sortMode">
				<label>
					sort by:
					<select>
						<option>newest first</option>
						<option>oldest first</option>
					</select>
					<SVGIcon src="/icons/chevron-down.svg" class="arrow"/>
				</label>
			</div>
			<div class="viewModes">
				<label>
					<SVGIcon src="/icons/layout-grid.svg" />
					<input type="radio" name="viewMode" autocomplete="off" />
				</label>
				<label>
					<SVGIcon src="/icons/layout-list.svg" />
					<input type="radio" name="viewMode" autocomplete="off" />
				</label>
				<label>
					<SVGIcon src="/icons/layout-dashboard.svg" />
					<input type="radio" name="viewMode" autocomplete="off" checked />
				</label>
			</div>
			<details class="tagFilter" open>
				<summary>tag filters</summary>
				<div class="list">
					{taglist.map((tagData) => {
						return (
							<label class="checkbox">
								<span class="tagCount">({tagData.count})</span>
								<span class="tagName">{tagData.name}</span>
								<input type="checkbox" autocomplete="off" />
								<div class="stylizedCheckbox">
									<SVGIcon src="/icons/check.svg" class="checkIcon"/>
								</div>
							</label>
						);
					})}
				</div>
			</details>
		</aside>

		<main class="postlist contentBox">
			{posts.map((post: any) => {
				const pubDate: Date = post.data.pubDate;

				const dc = getUTCDateComponents(pubDate);

				const datepath = `${dc.year}/${dc.month}/${dc.day}`;

				const pubDateISO = post.data.pubDate.toISOString();
				const pubDateSimple = getSimplifiedDate(post.data.pubDate);

				let editDateISO;
				let editDateSimple;

				if (post.data.updatedDate) {
					editDateISO = post.data.updatedDate.toISOString();
					editDateSimple = getSimplifiedDate(post.data.updatedDate);
				}

				return (
					<a href={`/blog/${datepath}/${pubDate.getTime()}`} title={post.data.title}>
						<article>
							<Show when={post.data.image != null}>
								<div class="featuredImage">
									<img class="hover" src={post.data.image} />
									<img src={post.data.image} />
								</div>
							</Show>
							<GridTitle client:load>{post.data.title}</GridTitle>
							<span>posted <time datetime={pubDateISO}>{pubDateSimple}</time></span>
							<Show when={post.data.updatedDate != null}>
								<span class="updated">
									updated <time datetime={editDateISO}>{editDateSimple}</time>
								</span>
							</Show>
						</article>
					</a>
				)
			})}
		</main>
	</div>
</Base>

<style lang="scss">
	.wrapper {
		display: flex;
		flex-direction: row;
		align-items: flex-start;
		gap: var(--inner-void-gap);
	}

	aside {
		$ud-pad: 0.5rem;

		display: flex;
		flex-direction: column;
		gap: var(--inner-void-gap);
		width: 20rem;
		padding: calc(var(--edge-pad) / 2);

		.checkbox {
			display: flex;
			align-items: center;
			gap: var(--inner-void-gap);

			.tagCount {
				opacity: 0.5;
			}

			.tagName {
				overflow-wrap: anywhere;
			}

			input {
				display: none;
			}

			.stylizedCheckbox {
				display: flex;
				align-items: center;
				justify-content: center;
				width: 1.5rem;
				height: 1.5rem;
				background-color: var(--secondary-box-bg);
				color: var(--box-bg);
				margin-left: auto;

				:global(.checkIcon) {
					opacity: 0;
				}
			}

			input:checked ~ .stylizedCheckbox {
				background-color: var(--trim);

				:global(.checkIcon) {
					opacity: 1;
				}
			}
		}

		.searchBar {
			position: relative;

			input[type="search"] {
				width: 100%;
				background-color: var(--secondary-box-bg);
				color: var(--text);
				padding: $ud-pad 0.75rem;
				padding-right: calc(24px + ($ud-pad) * 2);
				font-size: 1rem;
				border: none;
			}

			:global(.searchIcon) {
				position: absolute;
				top: 50%;
				right: 0;
				margin-right: $ud-pad;
				transform: translateY(-50%);
				opacity: 0.5;
				pointer-events: none;
			}
		}

		.exactOnly {
			user-select: none;
		}

		.sortMode {
			user-select: none;

			label {
				position: relative;
				display: flex;
				align-items: center;
				width: 100%;
				gap: calc(var(--edge-pad) / 2);

				select {
					background-color: var(--secondary-box-bg);
					color: currentColor;
					padding: $ud-pad 0.75rem;
					font-size: 1rem;
					border: none;
					appearance: none;
					flex: 1;
				}

				:global(.arrow) {
					position: absolute;
					top: 50%;
					right: 0;
					margin-right: $ud-pad;
					transform: translateY(-50%);
					opacity: 0.5;
					pointer-events: none;
				}
			}
		}

		.viewModes {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: var(--inner-void-gap);

			label {
				display: flex;
				align-items: center;
				justify-content: center;
				background-color: var(--secondary-box-bg);
				height: 3rem;
				flex: 1;

				&:has(input:checked) {
					background-color: var(--trim);
					color: var(--box-bg);
				}
			}

			input {
				display: none;
			}
		}

		.tagFilter {
			user-select: none;

			summary {
				padding: calc(var(--inner-void-gap) / 2) 0;
			}

			.list {
				display: flex;
				flex-direction: column;

				.checkbox {
					padding: calc(var(--inner-void-gap) / 2) 0;
				}
			}
		}
	}

	.postlist {
		display: grid;
		grid-template-columns: repeat(3, 1fr);
		gap: var(--inner-void-gap);
		flex: 1;
		padding: calc(var(--edge-pad) / 2);
	}

	a {
		aspect-ratio: 1.5 / 1;
		width: 100%;
		text-decoration-color: transparent;
	}

	article {
		$gridPostPad: 1rem;
		position: relative;
		background-color: var(--trim);
		color: var(--box-bg);
		display: flex;
		flex-direction: column;
		height: 100%;
		padding: $gridPostPad;

		.featuredImage {
			position: absolute;
			width: 100%;
			height: 75%;
			margin: calc($gridPostPad * -1);
			margin-bottom: 2rem;
			background-color: var(--trim);
			mask-image: linear-gradient(to bottom, #666, black);
			mask-mode: luminance;
			mask-size: cover;;

			img {
				position: absolute;
				top: 0;
				left: 0;
				object-fit: cover;
				width: 100%;
				height: 100%;
				transition: all 250ms var(--anim-timing);
			}

			img:not(.hover) {
				filter: saturate(0);
				mix-blend-mode: multiply;
			}

			img.hover {
				z-index: 1;
				opacity: 0;
			}
		}

		// reordering elements doesnt change z-index 
		// for some reason so i have to do this
		:global(:not(.featuredImage)) {
			z-index: 10;
		}

		:global(.titleWrapper) {
			width: 100%;
			height: 80%;
			margin-bottom: auto;
			overflow: hidden;

			&:global(.overflowing) {
				mask-image: linear-gradient(to bottom, #FFF 50%, transparent calc(100% - 1em));
			}

			:global(h2) {
				text-decoration-line: underline;
				text-decoration-color: transparent;
				transition: all 250ms var(--anim-timing);
				overflow-wrap: anywhere;
				margin: 0;
			}
		}

		.updated {
			opacity: 0.5;
		}
	}

	a:is(:hover, :focus-visible) {
		article img {
			transition-duration: 0ms;
		}

		article img.hover {
			opacity: 1;
		}

		article img:not(.hover) {
			opacity: 0;
		}

		:global(h2) {
			text-decoration-color: currentColor;
			transition-duration: 0ms;
		}
	}
</style>